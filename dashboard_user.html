<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>☁️ Windy - Dashboard</title>
  <style>
    :root {
      --color-bg: linear-gradient(to bottom right, #15c747, #1b1494);
      --color-card: rgba(255, 255, 255, 0.1);
      --color-border: rgba(255, 255, 255, 0.2);
      --color-text: #fff;
      --color-btn: #ffa726;
      --color-input: #ffffff;
      --color-logout: #ef5350;
    }

    body {
      font-family: 'Quicksand', sans-serif;
      margin: 0;
      padding: 0;
      background: var(--color-bg);
      color: var(--color-text);
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      flex-direction: column;
    }

    .logout-container {
      width: 100%;
      display: flex;
      justify-content: flex-end;
      padding: 1rem;
    }

    .logout-btn {
      background: var(--color-logout);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      font-weight: bold;
      cursor: pointer;
    }

    .dashboard-card {
      background: var(--color-card);
      backdrop-filter: blur(10px);
      border: 1px solid var(--color-border);
      border-radius: 20px;
      padding: 2rem;
      width: 90%;
      max-width: 500px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .dashboard-title {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 2rem;
    }

    .dashboard-section {
      margin-bottom: 1.5rem;
    }

    .input-row {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }

    input, select {
      width: 100%;
      padding: 0.5rem;
      border-radius: 8px;
      border: none;
      margin-top: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    button {
      background-color: var(--color-btn);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    button:hover {
      background-color: #fb8c00;
    }

    .fav-list {
      list-style: none;
      padding-left: 0;
    }

    .fav-list li {
      background: rgba(255, 255, 255, 0.2);
      margin: 5px 0;
      padding: 0.5rem;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    footer {
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #ffffffcc;
    }

    body.sunset {
      --color-bg: linear-gradient(to bottom right, #fd746c, #ff9068);
    }

    body.night {
      --color-bg: linear-gradient(to bottom right, #141e30, #243b55);
    }
  </style>
</head>
<body data-page="dashboard">
  <div class="logout-container">
    <button class="logout-btn" onclick="logoutUser()">🚪 Logout</button>
  </div>

  <main class="dashboard-card">
    <h1 class="dashboard-title">xxx 🌤️ Welcome xxx, <span id="username">User</span></h1>

    <section class="dashboard-section">
      <label for="city">Check Weather:</label>
      <div class="input-row">
        <input type="text" id="city" placeholder="Enter a city...">
        <button onclick="checkWeather()">🔍 Check</button>
        <button id="saveFavBtn" onclick="saveToFavorites()">⭐ Save</button>
      </div>
    </section>

    <div id="weatherResult"></div>

    <section class="dashboard-section">
      <h3>❤️ Favorites (<span id="favCount">0/3</span>)</h3>
      <button id="refreshAllBtn" onclick="renderSaved()">🔁 Refresh</button>
      <ul id="savedCities" class="fav-list"></ul>
    </section>

    <section class="dashboard-section">
      <h3>⚙️ Profile Settings</h3>
      <label for="updateOption">Select what to update:</label>
      <select id="updateOption" onchange="renderProfileUpdateForm()">
        <option value="">-- Choose an option --</option>
        <option value="name">Update Name</option>
        <option value="email">Update Email</option>
        <option value="password">Update Password</option>
      </select>
      <div id="profileUpdateFields"></div>
      <button onclick="submitProfileUpdate()">📂 Update</button>
    </section>

    <section class="dashboard-section">
      <h3>🎨 Theme</h3>
      <select id="themeSelect" onchange="changeTheme()">
        <option value="default">🌈 Default</option>
        <option value="sunset">🌇 Sunset</option>
        <option value="night">🌙 Night</option>
      </select>
    </section>
  </main>

  <footer>© 2025 Windy Weather App</footer>

  <script>
    const GET_PREFS_URL = "https://0838uo8kkf.execute-api.eu-north-1.amazonaws.com/prod/user/prefs";
    const UPDATE_PREFS_URL = "https://0838uo8kkf.execute-api.eu-north-1.amazonaws.com/prod/user/prefs";

    let userEmail = localStorage.getItem("loggedInEmail") || "";

    window.onload = () => {
      if (!userEmail) {
        alert("User not logged in.");
        window.location.href = "login.html";
      } else {
        loadDashboard();
      }
    };

    function loadDashboard() {
      fetch(`${GET_PREFS_URL}?email=${encodeURIComponent(userEmail)}`)
        .then(async res => {
          const bodyRaw = await res.text(); // ✅ Only this
          try {
            const data = JSON.parse(bodyRaw);
            console.log("✅ Loaded user data:", data);

            // ✅ Set user name
            const displayName = data.name || "User";
            document.getElementById("username").textContent = displayName;

            // ✅ Apply theme
            const theme = data.theme || "default";
            document.body.className = theme;
            document.getElementById("themeSelect").value = theme;

            // ✅ Load favorites
            const favorites = Array.isArray(data.favorites) ? data.favorites : [];
            renderSavedFavorites(favorites);
          } catch (err) {
            console.error("❌ Error parsing user data:", err, bodyRaw);
            alert("⚠️ Error: Missing or invalid user data.");
          }
        })
        .catch(err => {
          console.error("❌ Error loading dashboard:", err);
          document.body.className = "default";
          document.getElementById("themeSelect").value = "default";
          renderSavedFavorites([]);
        });
    }

    function changeTheme() {
      const selectedTheme = document.getElementById("themeSelect").value;
      document.body.className = selectedTheme;
      updatePrefs({ theme: selectedTheme });
    }

    function checkWeather() {
      const city = document.getElementById("city").value.trim();
      if (!city) return;
      const apiKey = "3e1551bf87cae22bfd3014698a68ece2";
      const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;

      fetch(apiUrl)
        .then(res => res.json())
        .then(data => {
          if (data.cod === 200) {
            document.getElementById("weatherResult").innerHTML =
              `<p><strong>${data.name}, ${data.sys.country}</strong></p>
               <p>Temperature: ${data.main.temp}°C</p>
               <p>Condition: ${data.weather[0].description}</p>`;
          } else {
            document.getElementById("weatherResult").textContent = "City not found.";
          }
        })
        .catch(err => {
          console.error("Error fetching weather:", err);
          document.getElementById("weatherResult").textContent = "Failed to retrieve weather data.";
        });
    }


    function saveToFavorites() {
      const city = document.getElementById("city").value.trim();
      if (!city) return;

      fetch(`${GET_PREFS_URL}?email=${encodeURIComponent(userEmail)}`)
        .then(async res => {
          const bodyRaw = await res.text();
          let data;
          try {
            data = JSON.parse(bodyRaw);
            if (!data || typeof data !== "object") throw new Error("Invalid user data");
          } catch (e) {
            console.error("❌ Error parsing fetched prefs:", e);
            return alert("⚠️ Could not load user preferences.");
          }

          let favs = Array.isArray(data.favorites) ? data.favorites : [];

          if (favs.some(f => f.toLowerCase().includes(city.toLowerCase()))) return alert("⚠️ Already added.");
          if (favs.length >= 3) return alert("⚠️ Only 3 favorites allowed.");

          const apiKey = "3e1551bf87cae22bfd3014698a68ece2";
          const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`;

          fetch(apiUrl)
            .then(res => res.json())
            .then(weather => {
              if (weather.cod === 200) {
                const fullCity = `${weather.name}, ${weather.sys.country} - ${weather.main.temp}°C`;
                favs.push(fullCity);
                updatePrefs({ favorites: favs });
                renderSavedFavorites(favs);
              } else {
                alert("⚠️ City not found.");
              }
            })
            .catch(err => {
              console.error("❌ Weather fetch failed:", err);
              alert("⚠️ Weather lookup failed.");
            });
        })
        .catch(err => {
          console.error("❌ Failed to fetch user prefs:", err);
          alert("⚠️ Could not fetch user preferences.");
        });
    }


    function renderSavedFavorites(favorites) {
      const favList = document.getElementById("savedCities");
      favList.innerHTML = "";
      document.getElementById("favCount").textContent = `${favorites.length}/3`;

      favorites.forEach(originalCity => {
        const cleanCity = originalCity.includes(" - ") ? originalCity.split(" - ")[0] : originalCity;
        const apiKey = "3e1551bf87cae22bfd3014698a68ece2";
        const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${cleanCity}&appid=${apiKey}&units=metric`;

        fetch(apiUrl)
          .then(res => res.json())
          .then(data => {
            const fullCity = `${data.name}, ${data.sys.country} - ${data.main.temp}°C`;
            addCityToList(fullCity, originalCity);
          })
          .catch(() => {
            addCityToList(originalCity, originalCity); // fallback
          });
      });

    function addCityToList(displayCity, originalCity) {
      const li = document.createElement("li");
      li.textContent = displayCity;

      const removeBtn = document.createElement("button");
      removeBtn.textContent = "❌";
      removeBtn.onclick = () => {
        const updated = favorites.filter(c => {
          const base = c.split(" - ")[0];
          const originalBase = originalCity.split(" - ")[0];
          return base !== originalBase;
        });

        updatePrefs({ favorites: updated });
        renderSavedFavorites(updated);
      };

      li.appendChild(removeBtn);
      favList.appendChild(li);
    }
  }

  function renderSaved() {
      fetch(`${GET_PREFS_URL}?email=${encodeURIComponent(userEmail)}`)
        .then(async res => {
          const bodyRaw = await res.text();
          try {
            const data = JSON.parse(bodyRaw);
            const favs = Array.isArray(data.favorites) ? data.favorites : [];
            renderSavedFavorites(favs);
          } catch (err) {
            console.error("Error refreshing favorites:", err, bodyRaw);
            renderSavedFavorites([]);
          }
        })
        .catch(err => {
          console.error("Fetch failed:", err);
          renderSavedFavorites([]);
        });
    }

    function updatePrefs(prefs) {
  fetch(UPDATE_PREFS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email: userEmail, ...prefs })
  })
  .then(res => res.json())
  .then(data => {
    if (data.message && data.message.toLowerCase().includes("success")) {
      console.log("Preferences updated!");
    } else {
      throw new Error(data.message || "Update failed.");
    }
  })
  .catch(err => {
    console.error("Update failed:", err);
    alert("❌ Failed to update preferences. " + err.message);
  });
}

    function logoutUser() {
      localStorage.removeItem("loggedInEmail");
      window.location.href = "login.html";
    }

    function renderProfileUpdateForm() {
      const option = document.getElementById("updateOption").value;
      const container = document.getElementById("profileUpdateFields");
      container.innerHTML = "";

      if (option === "name") {
        container.innerHTML = `
          <input type="email" id="currentEmail" placeholder="Current email" required>
          <input type="text" id="newName" placeholder="New name" required>`;
      } else if (option === "email") {
        container.innerHTML = `
          <input type="email" id="currentEmail" placeholder="Current email" required>
          <input type="email" id="newEmail" placeholder="New email" required>`;
      } else if (option === "password") {
        container.innerHTML = `
          <input type="email" id="currentEmail" placeholder="Current email" required>
          <input type="password" id="newPassword" placeholder="New password" required>`;
      }
    }

    function submitProfileUpdate() {
  const option = document.getElementById("updateOption").value;
  const currentEmail = document.getElementById("currentEmail")?.value.trim();
  const name = document.getElementById("newName")?.value.trim();
  const newEmail = document.getElementById("newEmail")?.value.trim();
  const password = document.getElementById("newPassword")?.value.trim();

  if (!currentEmail) return alert("Please enter your current email.");
  const payload = { email: currentEmail };

  if (option === "name" && name) payload.name = name;
  else if (option === "email" && newEmail) {
    payload.previousEmail = currentEmail;
    payload.email = newEmail;
  }
  else if (option === "password" && password) payload.password = password;
  else return alert("Please fill in the required fields.");

  fetch(UPDATE_PREFS_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  })
  .then(res => res.json())
  .then(data => {
    if (data.message && data.message.toLowerCase().includes("success")) {
      alert("Update successful!");
      if (option === "email" && newEmail) {
        localStorage.setItem("loggedInEmail", newEmail);
        userEmail = newEmail;
      }
    } else {
      throw new Error(data.message || "Update failed.");
    }
  })
  .catch(err => {
    console.error("Update failed:", err);
    alert("❌ Failed to update profile. " + err.message);
  });
}

  </script>
</body>
</html>
